<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
<script type="text/javascript" src="http://getbootstrap.com/dist/js/bootstrap.js"></script>
<link type="text/css" rel="stylesheet" href="http://getbootstrap.com/dist/css/bootstrap.css">

<style type="text/css">body {
        font-family:Century Gothic, Arial, Helvetica, sans-serif;
}
p{
  margin-top:10px;
}
form {
  position: absolute;
  right: 10px;
  top: 10px;
}

#code_hierarchy
{
    margin:0 auto;
}

#code_hierarchy_legend
{
    height:10px;
	float:right;padding-top:10px;
    text-align:center;
}

p
{
    font-size:1.2em;
}
path{
  stroke: #fff;
}
path.hovered{
  stroke: #feb24c;
  stroke-width : 2;
  stroke-opacity: 1;
}
path.active{
  stroke: #fff;
  stroke-width : 2;
  stroke-opacity: 1;
}

h1 {
  text-align: center;
  line-height: 100%;
  margin: .5em 0;
}

h3 {
  text-align: center;
  line-height: 100%;
}

p {
  text-align: center;
}

#annotation {
    border: 3px solid rgb(102, 122, 102);
    margin-top: 0px;
    padding-left: 6px;
    padding-top: 0px;
    border-radius: 4px;
    position: absolute;
    min-height: 1.2em;
    width: 340px;
    top: 140px;
    right: 20px;
    background-color: rgb(102, 122, 102);
    color: white;
}
</style>


<title>Student Classes</title>
</head>
<body data-pinterest-extension-installed="ff1.35">
<link rel="stylesheet" type="text/css" href="style.css">

<h3>Dept of Public Admin</h3>
<h1>Course Utilization by Specialization</h1>
<p>Student sample size: NR: 16; GL: 10; LG: 10; NP: 10; HR: 7<p>

	<div id="body">
<!--
		<div id="annotation">
			<p>Hover over a course number to see its title.</p>
		</div>
-->
		<div class="container">
			<div id="code_hierarchy"><svg height="1040" width="1040"></svg></div>
		</div> 
	</div>

	
<script>
$(document).ready(function() {
    
//JM: Load the data, then do everything in this callback	
d3.json("dpa-course-utilization-wheel.json", function(error, myJSON) {

	function init_code_hierarchy_plot(element_id,data) {
		var plot = document.getElementById(element_id);
		while (plot.hasChildNodes())
		{
			plot.removeChild(plot.firstChild);
		}

		//JM: Define some constants - indexes into the JSON data structure, 
		//which is still a bit of a mystery to me
		var name_index = 0; // not used
		var count_index = 1; // JM: not clear on usage of this. I think this is my sizing element
		var children_index = 3;
		var color_index = 5;

		var width = plot.offsetWidth;
		var height = width;
		var x_margin = 40;
		var radius = width/7;
		var y_margin = 40;
		var content = d3.select("#annotation"); // To display course titles on mouse hover
	   
		var max_depth=3;
		
		var data_slices = [];
		var max_level = 4;
		var color = d3.scale.category20c();

		var svg = d3.select("#"+element_id).append("svg")
			.attr("width", width)
			.attr("height", height)
			.append("g")
			.attr("transform", "translate(" + width / 2 + "," + height * .52 + ")");
		  
		function process_data(data,level,start_deg,stop_deg)
		{
			var name = data[0];
			var total = data[1]; //JM: I think this is my sizing element... "total"
			var children = data[children_index];
			var current_deg = start_deg;
			var parent = '';

			if (level > max_level)     { return; }
			if (start_deg == stop_deg) { return; }
						
			data_slices.push([start_deg,stop_deg,name,level,data[1],data[2]]);
			
			for (var key in children)
			{
				child = children[key];
				
				var inc_deg = (stop_deg-start_deg)/total*child[count_index];
				var child_start_deg = current_deg;
				
				current_deg+=inc_deg;
				
				var child_stop_deg = current_deg;
				var span_deg = child_stop_deg-child_start_deg;
				
				// JM: Recursing?
				process_data(child,level+1,child_start_deg,child_stop_deg);
			}
		}
		
		process_data(data,0,0,360./180.0*Math.PI);

		var ref = data_slices[0];
		var next_ref = ref;
		var last_refs = [];

		var thickness = width/2.0/(max_level+2)*1.1;
			
		var arc = d3.svg.arc()
		.startAngle(function(d) { if(d[children_index]==0){return d[0];}return d[0]+0.01; })
		.endAngle(function(d) { if(d[children_index]==0){return d[1];}return d[1]-0.01; })
		.innerRadius(function(d) { return 1.1*d[children_index]*thickness; })
		.outerRadius(function(d) { return (1.1*d[children_index]+1)*thickness; });    
		
		var slices = svg.selectAll(".form-container")
			.data(function(d) { return data_slices; })
			.enter()
			.append("g")
			.classed('form-container', true);
			
		slices.append("path")
			.attr("d", arc)
			.attr("id",function(d,i){return d[2]+""+i;})
			.style("fill", function(d) { return color(d[2]);}) // JM: leaving this in to get some default colors
			.style("fill", function(d) { return d[color_index];}) // JM: overriding the fill color with value from the JSON
														// JM: FYI: d[3] is the level or depth of the datum
			.on("click",animate)
			.on("mouseover", mouseover) // JM: for hover
			.on("mouseout", mouseout)   // JM: for hover     
			.attr("class","form")
			.append("svg:title")
			.text(function(d) { return Math.round(d[0]*100)/100 +" , "+ Math.round(d[1]*100)/100; });

		function getAngle(d) {
			var thetaDeg = (180 / Math.PI * (arc.startAngle()(d) + arc.endAngle()(d)) / 2 - 90);
			return (thetaDeg > 90) ? thetaDeg - 180 : thetaDeg;
		}
		
		slices.append("text")
			.classed('label', true)
			.style("font-size", "16px")
			.attr("x", function(d) { return d[1]; })
			.attr("text-anchor", "middle")
			.style("fill", function(d) { // White text for dark backgrounds; dark text for light backgrounds
				return brightness(d3.rgb(d[color_index])) < 125 ? "#eee" : "#000"; // #000 is black
			})
			.attr("transform", function(d) { 
				return "translate(" + arc.centroid(d) + ")" + 
					   "rotate("    + getAngle(d) +     ")"; })
			.attr("dx", "6") // margin
			.attr("dy", ".35em") // vertical-align
			.text(function(d){return d[2]})
			.attr("pointer-events","none");

		function get_start_angle(d,ref) {
			if (ref)
			{
				var ref_span = ref[1]-ref[0];
				return (d[0]-ref[0])/ref_span*Math.PI*2.0
			}
			else
			{
				return d[0];
			}
		}
		
		function get_stop_angle(d,ref) {
			if (ref)
			{
				var ref_span = ref[1]-ref[0];
				return (d[1]-ref[0])/ref_span*Math.PI*2.0
			}
			else
			{
				return d[0];
			}
		}
		
		function get_level(d,ref) {
			if (ref)
			{
				return d[children_index]-ref[children_index];
			}
			else
			{
				return d[children_index];
			}
		}
		
		function change_ref(data_point, reference_point) {
			return [
				get_start_angle(data_point, reference_point),
				get_stop_angle (data_point, reference_point),
				data_point[2],
				get_level      (data_point, reference_point)
			];
		}
		
		function rebaseTween(new_ref) {
			return function(d) {
				var level = d3.interpolate(get_level(d,ref),get_level(d,new_ref));
				var start_deg = d3.interpolate(get_start_angle(d,ref),get_start_angle(d,new_ref));
				var stop_deg = d3.interpolate(get_stop_angle(d,ref),get_stop_angle(d,new_ref));
				var opacity = d3.interpolate(100,0);
				return function(t)
				{
					return arc([start_deg(t),stop_deg(t),d[2],level(t)]);
				}
			}
		}
		
		 //JM: mouseover function which will send the values to the legend
		 // Not yet working
		function mouseover(d) {
			content.append("p")
			.attr("id", "annotate")
	//        .text(d.title ? d.name + ": " + d.title : ' ')
			.text(function(d){return d[2]})
		}

		//JM: mouseout function which removes the values and replaces them with a blank space
		// Not yet working
		function mouseout(d) {
			content.html(' ');
		}

		var animating = false;
		
		function animate(d) {
			d3.select(this).classed('active',true).classed('hovered',false); 
			if (animating)
			{
				return;
			}
			animating = true;
			var revert = false;
			var new_ref;
			if (d == ref && last_refs.length > 0)
			{
				revert = true;
				last_ref = last_refs.pop();
			}
			if (revert)
			{
				d = last_ref;
				new_ref = ref;
				svg.selectAll(".form-container")
				.filter(
					function (b) {
						if (b[0] >= last_ref[0] && b[1] <= last_ref[1]  && b[children_index] >= last_ref[children_index])
						{
							return true;
						}
						return false;
					}
				)
				.transition().duration(1000).style("opacity","1").attr("pointer-events","all");
			}
			else
			{
				new_ref = d;
				svg.selectAll(".form-container")
				.filter(
					function (b) {
						if (b[0] < d[0] || b[1] > d[1] || b[children_index] < d[children_index])
						{
							return true;
						}
						return false;
					}
				)
				.transition().duration(1000).style("opacity","0").attr("pointer-events","none");
			}
			svg.selectAll(".form")
			.filter(
				function (b) {
					if (b[0] >= new_ref[0] && b[1] <= new_ref[1] && b[children_index] >= new_ref[children_index])
					{
						return true;
					}
					return false;
				}
			)
			.transition().duration(1000).attrTween("d",rebaseTween(d));
			
			svg.selectAll('.label')
			.filter(
				function (b) {
					return b[0] >= new_ref[0] && b[1] <= new_ref[1] && b[children_index] >= new_ref[3];
				}
			).transition().duration(1000)
			 .attr("transform", function(b) {
				 var b_prime = change_ref(b, d);
				 return "translate(" + arc.centroid(b_prime) + ")" + 
						"rotate("    + getAngle(b_prime) +     ")"; 
			 })
						 
			setTimeout(function(){
				animating = false;
				if (! revert)
				{
					last_refs.push(ref);
					ref = d;
				}
				else
				{
					ref = d;
				}
				},1000);
		};  

	}

	// http://www.w3.org/WAI/ER/WD-AERT/#color-contrast
	function brightness(rgb) {
	  return rgb.r * .299 + rgb.g * .587 + rgb.b * .114;
	}

	init_code_hierarchy_plot("code_hierarchy", myJSON);
	});
});

</script>
 <img src="GL-Course-Utilization.jpg" alt="GL Course Utilization" align="middle"> 
 <img src="LG-Course-Utilization.jpg" alt="GL Course Utilization" align="middle"> 
 <img src="HR-Course-Utilization.jpg" alt="GL Course Utilization" align="middle"> 
 <img src="NR-Course-Utilization.jpg" alt="NR Course Utilization" align="middle"> 
 <img src="NP-Course-Utilization.jpg" alt="GL Course Utilization" align="middle"> 


 </body>
